# Nginx â€” Bot seul avec SSL (app.zychadmeta.com)
# Certificats : nginx/ssl/fullchain.pem et privkey.pem

events { worker_connections 1024; }
http {
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    gzip on;
    gzip_types text/css application/json application/javascript text/xml image/svg+xml;
    client_max_body_size 500M;
    server_tokens off;

    upstream bot {
        server bot:5000;
    }

    server {
        listen 80;
        server_name app.zychadmeta.com;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name app.zychadmeta.com;

        ssl_certificate     /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;

        location / {
            auth_request /auth/verify;
            auth_request_set $auth_status $upstream_status;
            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_plan $upstream_http_x_user_plan;

            proxy_pass http://bot/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Plan $user_plan;

            proxy_read_timeout 300s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;

            error_page 401 = @login_redirect;
            error_page 403 = @upgrade_redirect;
        }

        location = /auth/verify {
            internal;
            proxy_pass https://www.zychadmeta.com/api/auth/verify$is_args$args;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Cookie $http_cookie;
            proxy_set_header Host www.zychadmeta.com;
            proxy_set_header X-Original-Host $host;
            proxy_set_header X-Forwarded-Proto https;
            proxy_ssl_server_name on;
        }

        location @login_redirect {
            return 302 https://www.zychadmeta.com/login?redirect=https://app.zychadmeta.com/;
        }
        location @upgrade_redirect {
            return 302 https://www.zychadmeta.com/billing?reason=quota;
        }

        location ~ /\. { deny all; }
    }
}
