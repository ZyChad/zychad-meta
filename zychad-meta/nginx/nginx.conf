events { worker_connections 1024; }
http {
    gzip on;
    gzip_types text/css application/json application/javascript text/xml image/svg+xml;
    client_max_body_size 500M;
    server_tokens off;
    proxy_hide_header X-Powered-By;

    upstream web {
        server web:3000;
    }

    upstream bot {
        server bot:5000;
    }

    server {
        listen 80;
        server_name localhost zychadmeta.com;

        # Pages Next.js (landing, auth, billing, settings, API)
        location / {
            proxy_pass http://web;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Le bot — protégé par auth_request
        location /app/ {
            auth_request /auth/verify;
            auth_request_set $auth_status $upstream_status;
            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_plan $upstream_http_x_user_plan;

            proxy_pass http://bot/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Plan $user_plan;

            proxy_read_timeout 300s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;

            error_page 401 = @login_redirect;
            error_page 403 = @upgrade_redirect;
        }

        # Endpoint interne de vérification
        location = /auth/verify {
            internal;
            proxy_pass http://web/api/auth/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Cookie $http_cookie;
        }

        location @login_redirect {
            return 302 /login?redirect=/app/;
        }
        location @upgrade_redirect {
            return 302 /billing?reason=quota;
        }

        location ~ /\. { deny all; }
    }
}
